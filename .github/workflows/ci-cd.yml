name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.9'
  NODE_VERSION: '18'

jobs:
  # ====================
  # Unit Tests
  # ====================
  test-python-unit:
    name: Python Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Run data pipeline
      run: |
        python src/data/data_pipeline.py

    - name: Train models (for test fixtures)
      run: |
        python src/models/train.py

    - name: Run FastAPI unit tests
      run: |
        pytest tests/test_fastapi.py -v --cov=src/api --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: fastapi-unit
        name: fastapi-unit-coverage

  test-lambda-unit:
    name: Lambda Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Run Lambda unit tests
      run: |
        pytest tests/test_lambda_unit.py -v --cov=src/lambda --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: lambda-unit
        name: lambda-unit-coverage

  # ====================
  # Infrastructure Tests
  # ====================
  test-cdk-infrastructure:
    name: CDK Infrastructure Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: infrastructure/package-lock.json

    - name: Install CDK dependencies
      working-directory: infrastructure
      run: npm ci

    - name: Run CDK tests
      working-directory: infrastructure
      run: npm test -- --coverage

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./infrastructure/coverage/lcov.info
        flags: cdk-infrastructure
        name: cdk-infrastructure-coverage

  # ====================
  # Integration Tests
  # ====================
  test-api-integration:
    name: API Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python-unit]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .

    - name: Run data pipeline
      run: |
        python src/data/data_pipeline.py

    - name: Train models
      run: |
        python src/models/train.py

    - name: Start FastAPI server
      run: |
        python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000 &
        echo $! > api.pid

    - name: Wait for API to be ready
      run: |
        timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 1; done'

    - name: Test API health endpoint
      run: |
        curl -X GET "http://localhost:8000/health" | jq .

    - name: Test API predict endpoint
      run: |
        curl -X POST "http://localhost:8000/predict" \
          -H "Content-Type: application/json" \
          -d '{"MedInc": 8.3252, "HouseAge": 41.0, "AveRooms": 6.984, "AveBedrms": 1.024, "Population": 322.0, "AveOccup": 2.555, "Latitude": 37.88, "Longitude": -122.23}' \
          | jq .

    - name: Stop API server
      if: always()
      run: |
        if [ -f api.pid ]; then kill $(cat api.pid) || true; fi

  # ====================
  # Docker Build & Test
  # ====================
  test-docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: [test-python-unit]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: docker/Dockerfile
        tags: house-price-api:test
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker container
      run: |
        docker run -d -p 8000:8000 --name test-container house-price-api:test
        sleep 30
        curl -X GET "http://localhost:8000/" | jq .
        curl -X GET "http://localhost:8000/health" | jq .
        docker stop test-container
        docker rm test-container

  # ====================
  # Code Quality
  # ====================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy pylint
        pip install -r requirements.txt
        pip install -e .

    - name: Run flake8
      run: |
        flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 src/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Check code formatting with black
      run: |
        black --check src/ tests/

    - name: Check import sorting with isort
      run: |
        isort --check-only src/ tests/

    - name: Run type checking with mypy
      run: |
        mypy src/ --ignore-missing-imports || true

  # ====================
  # Security Scan
  # ====================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Run safety check (dependency vulnerabilities)
      run: |
        pip install -r requirements.txt
        safety check --json || true

    - name: Run bandit (security issues in code)
      run: |
        bandit -r src/ -f json || true

  # ====================
  # Summary Job
  # ====================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - test-python-unit
      - test-lambda-unit
      - test-cdk-infrastructure
      - test-api-integration
      - test-docker
      - code-quality
      - security-scan
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "All tests completed!"
        echo "Python Unit Tests: ${{ needs.test-python-unit.result }}"
        echo "Lambda Unit Tests: ${{ needs.test-lambda-unit.result }}"
        echo "CDK Infrastructure Tests: ${{ needs.test-cdk-infrastructure.result }}"
        echo "API Integration Tests: ${{ needs.test-api-integration.result }}"
        echo "Docker Tests: ${{ needs.test-docker.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"

    - name: Fail if any test failed
      if: |
        needs.test-python-unit.result == 'failure' ||
        needs.test-lambda-unit.result == 'failure' ||
        needs.test-cdk-infrastructure.result == 'failure' ||
        needs.test-api-integration.result == 'failure' ||
        needs.test-docker.result == 'failure'
      run: exit 1

  # ====================
  # Deploy (only on main branch after all tests pass)
  # ====================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test-summary
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        cd infrastructure && npm ci

    - name: Run data pipeline
      run: python src/data/data_pipeline.py

    - name: Train and upload models to S3
      run: python src/models/train_s3.py

    - name: Deploy CDK stack
      working-directory: infrastructure
      run: |
        npm run build
        npx cdk deploy --require-approval never

    - name: Test deployed API
      run: |
        # Get API URL from CDK outputs
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name MLPipelineStack \
          --query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
          --output text)
        echo "Testing API at: $API_URL"
        curl -X GET "${API_URL}health" | jq .